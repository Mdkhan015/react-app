import { useQuery } from '@tanstack/react-query';

import { useRef, useState } from 'react';
import { searchNotes } from '../utility/http';
import ErrorBlock from './ErrorBlock';
import LoadingBlock from './LoadingBlock';
import Note from './Note';

const FindNote = () => {
  const [searchTerm, setSearchTerm] = useState('');
  const inputRef = useRef(null);
  const {
    data = [],
    isLoading,
    isError,
    error,
  } = useQuery({
    queryKey: ['notes', { searchTerm }],
    queryFn: () => searchNotes(searchTerm),
  });

  const handleSearch = (event) => {
    setSearchTerm(event.target.value);
  };

  // useEffect(() => {
  //   // debounce the API call
  //   const timeoutId = setTimeout(async () => {
  //     setSearchResults([]);
  //     if (!searchTerm) return;
  //     setError('');
  //     setIsLoading(true);
  //     try {
  //       const response = await fetch(`http://localhost:8001/search?query=${searchTerm}`);
  //       const data = await response.json();
  //       setSearchResults(data);
  //     } catch (error) {
  //       setError('Something went wrong!');
  //     } finally {
  //       setIsLoading(false);
  //     }
  //   }, 500); // wait for 500ms before making the API call

  //   // clear the timeout on every key press
  //   return () => clearTimeout(timeoutId);
  // }, [searchTerm]);

  let content = 'Type anything to search notes!';

  if (isLoading) {
    content = <LoadingBlock />;
  }

  if (isError) {
    content = <ErrorBlock message={error.message} />;
  }

  if (data) {
    content = data.map((note) => <Note key={note.id} note={note} />);
  }

  const handleSubmit = (event) => {
    event.preventDefault();
    console.log(inputRef.current.value);
    setSearchTerm(inputRef.current.value);
  };

  return (
    <div className='find-note-container'>
      <form onSubmit={handleSubmit}>
        <input type='text' placeholder='Search notes' ref={inputRef} />
        <button type='submit'>Submit</button>
      </form>

      <div className='search-results-container'>{content}</div>
    </div>
  );
};

export default FindNote;
